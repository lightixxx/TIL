# Error Handling
코드에서 오류를 찾아내고, 또한 잠재적인 오류를 원활하게 처리할 수 있는 코드를 작성하는 기법에 대해 설명한다.

<br />

## 실행 순서
스크립트가 어떻게 처리되는지를 이해하면 오류의 원인을 찾는데 도움이 된다. 특정 구문이 실행되는 순서는 약간 복잡하다. 어떤 작업은 다른 구문이나 함수의 실행이 완료되기 전까지는 종료되지 않기도 한다.
```jsx
// 2
function greetUser() {
  return 'Hello ' + getName();
}

// 3
function getName() {
  var name = 'lightix';
  return name;
}

// 1
var gretting = greetUser();

// 4
console.log(gretting);
```
위 코드의 실행순서를 단순히 1, 2, 3, 4 라고 생각할 수 있지만 실제로는 이보다 조금 더 복잡하다.

1번 코드의 실행을 완료하기 위해서 자바스크립트 엔진은 2번의 함수와 3번의 함수(리턴한 값을 2번에서 사용하기 때문에)의 결과가 필요하다. 따라서 실행순서는 1, 2, 3, 2, 1, 4가 된다.

- 1 greetUser() 함수의 결과를 greeting 변수에 저장한다.
- 2 greetUser() 함수는 '안녕하세요 '라는 문자열과 getName()의 결과를 조합해서 메시지를 구성한다. 
- 3 getName() 함수는 변수 name에 'lightix'를 저장하고 greetUser() 함수에 리턴한다.
- 2 greetUser() 함수는 '안녕하세요 ' 와 3번에서 리턴한 name 값을 합쳐서 자신을 호출한 1번으로 결과값을 리턴한다.
- 1 greeting 변수 값이 메모리에 저장된다.
- 4 greeting 변수 값을 console에 출력한다.

<br />

## Execution Context (실행 컨텍스트)
실행 가능한 코드가 실행되기 위해 필요한 환경을 말한다. 실행 컨텍스트는 전역 객체 하나가 존재하며, 함수마다 새로운 실행 컨텍스트를 생성한다. 이 컨텍스트에 의해 변수의 스코프가 결정된다.

<br />

스크립트의 모든 구문은 세 가지 중 하나의 컨텍스트 내에 존재한다.
1. 전역 컨텍스트(global context): 스크립트 중 함수가 아닌 영역에 존재하는 코드는 이 컨텍스트에서 실행된다. 모든 페이지를 통틀어 전역 컨텍스트는 단 하나뿐이다.
2. 함수 컨텍스트(function context): 함수 내에서 실행되는 코드들은 이 컨텍스트 내에 존재한다. 각 함수는 각자의 함수 컨텍스트를 보유하고 있다.
3. 평가 컨텍스트(eval context): 내부함수인 eval() 함수에 의해 코드처럼 실행되는 텍스트는 이 컨텍스트 내에 존재한다.

일반적으로 실행 가능한 코드는 전역 컨텍스트와 함수 컨텍스트이다.

<br />

변수의 스코프에 대응하는 컨텍스트는 다음의 두 가지이다.
1. 전역 스코프(global scope): 변수가 함수 바깥에 선언되어 있으면 전역 스코프에 포함되기 때문에 어느 곳에서든 사용할 수 있다. 만약 변수를 선언할 때 `var` 키워드를 사용하지 않으면, 이 변수는 전역 스코프에 포함된다.
2. 함수 수준 스코프(function scope): 변수가 함수 내에서 선언되면 이 변수는 해당 함수 내에서만 사용할 수 있다. 이 변수는 함수 수준 스코프 내에 존재하기 때문이다.


## Stack (스택)
자바스크립트 엔진은 한 번에 한 줄의 코드를 실행한다. 어떤 구문이 다른 함수로부터 얻을 수 있는 데이터가 필요하면, 새로운 함수를 현재 스택 위에 추가한다(쌓는다). 또한 스택은 LIFO(Last In First Out, 후입선출)의 구조를 가지는 나열구조이다.

- 어떤 구문이 작업을 수행하면서 다른 코드를 호출해야 할 경우에는 새로운 작업이 수행할 작업의 상단에 놓이게 된다.
- 일단 새로운 작업을 실행하고 나면 엔진은 이전에 수행하던 작업으로 되돌아간다.
- 새 아이템이 스택에 추가될 때마다 새로운 실행 컨텍스트가 생성된다.
- 함수(혹은 실행컨텍스트) 내에 선언된 변수들은 해당 함수에서만 사용할 수 있다.
- 함수가 두 번째로 호출되면 변수는 다른 값을 가질 수도 있다.

아래의 다이어그램을 통해 앞에서 살펴본 코드가 어떻게 스택에 놓이면서 실행되는지 파악해보자.

![논리적 스택 구조를 가지는 실행 컨텍스트 스택](https://user-images.githubusercontent.com/59480963/93431923-c98c8580-f8ff-11ea-8bc6-394208124462.jpg)

위 이미지와 같이 실행 컨텍스트 스택이 생성되고 소멸한다. 현재 실행 중인 컨텍스트에서 이 컨텍스트와 관련 없는 코드가 실행되면 새로운 컨텍스트가 생성되고, 이 컨텍스트는 스택에 쌓이게 되고 제어권이 이동한다.

<br />

자바스크립트는 새로운 실행 컨텍스트를 만날 때마다 두 단계의 작업을 실행한다.
1. 준비
   * 새로운 스코프를 생성한다.
   * 변수, 함수, 인수를 생성한다.
   * `this` 키워드의 값을 결정한다.
2. 실행
   * 변수에 값을 대입할 수 있다.
   * 함수를 참조해서 그 코드를 실행할 수 있다.
   * 구문을 실행한다.

다시 [hoisting](https://github.com/lightixxx/TIL/blob/master/JavaScript/learnMore/hoisting.md)로 돌아가면, 두 가지 사항은 이미 알아봤다.
1. 함수를 선언하기 전에 호출할 수 있다.(함수 표현식이 아니라 함수 선언을 통해 생성한 경우)
2. 아직 선언하지 않은 변수에 값을 대입할 수 있다.

위와 같은 현상은 변수와 함수는 실행되기 전에 각각의 실행 컨텍스트 내에 생성되기 때문에 가능하다.

준비 단계는 주로 모든 변수와 함수를 가져와 실행 컨텍스트의 최상위에 호이스팅한다. 또는 이 변수들이 준비되었다고 생각해도 무방하다. 

각 실행 컨텍스트는 각각의 variables 객체를 갖고있다. 이 객체는 실행 컨텍스트 내의 모든 변수와 함수, 매개변수에 대한 상세 정보를 저장한다.


<br />

자바스크립트 엔진은 코드를 실행하기 위해 아래와 같은 정보들이 필요하다.
- 변수: 전역변수, 지역변수, 매개변수, 객체의 프로퍼티
- 함수 선언
- Scope
- this

자바스크립트 엔진은 이 정보들을 형상화하고 구분하기위해 실행 컨텍스트를 물리적 객체의 형태로 관리한다.

<br />

### 실행 컨텍스트의 3가지 객체
각 실행 컨텍스트는 각자의 variables 객체를 갖는다. 이 객체는 변수, 함수, 사용 가능한 매개변수를 모두 그 안에 저장한다. 또한 각 실행 컨텍스트는 부모의 variables에도 접근이 가능하다.

실행 컨텍스트는 실행가능한 코드를 형상화하고 구분하는 추상적인 개념이지만, 물리적으로는 객체의 형태를 가지며 아래의 3가지 프로퍼티를 갖고있다.

|Execution Context||
|:---|:----|
|Variable object | {vars, function declarations, arguments...} |
|Scope chain | [Varialbe object + all parent scopes] |
|thisValue|Context object|

<br />

1. Variable Object(VO / 변수객체)
    * 실행에 필요한 여러 정보들을 담을 객체이다.
    * 변수, 매개변수와 인수 정보, 함수 선언(표현식은 제외)를 담는 객체이다.
      + 전역 컨텍스트: 스크립트 중 함수가 아닌 영역에 존재하는 코드는 이 컨텍스트에서 실행된다. 모든 페이지를 통틀어 전역 컨텍스트는 단 하나뿐이다.
      + 함수 컨텍스트: 함수 내에서 실행되는 코드들은 이 컨텍스트 내에 존재한다. 각 함수는 각자의 함수 컨텍스트를 보유하고 있다.
2. Scope Chain (스코프 체인)
    * 일종의 리스트로서 전역 객체와 중첩된 함수의 스코프의 레퍼런스를 차례로 저장한다.
    * 해당 전역 또는 함수가 참조할 수 있는 변수, 함수 선언 등의 정보를 담고 있는 전역객체 또는 확성객체의 리스트를 가리킨다.
    * 엔진은 Scope Chain을 통해 Lexical Scope를 파악한다. 이는 자신이 정의된 객체와 연결되어 있다. 따라서 각 실행 컨텍스트의 스코프는 현재 실행 컨텍스트의 variables 객체에 부모 실행 컨텍스트의 variables 객체를 더한 것과 같다.
3. this value
    * this 프로퍼티에는 this 값이 할당된다. this에 할당되는 값은 함수 호출 패턴에 의해 결정된다.